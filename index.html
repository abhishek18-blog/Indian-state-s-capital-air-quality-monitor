<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indian Capitals Air Quality Monitor</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c0e18;
            color: #e2e8f0;
        }
        .card {
            background-color: #1a202c;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid #2d3748;
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease-in-out;
        }
        .card:hover {
            border-color: #3b82f640; 
            box-shadow: 0 5px 30px rgba(59, 130, 246, 0.2); 
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        .quality-status-badge {
            padding: 0.3rem 1rem;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 0.875rem;
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
        }
        #data-table-body-wrapper {
            max-height: 30rem;
            overflow-y: auto;
        }
        #data-table-body-wrapper::-webkit-scrollbar { width: 8px; }
        #data-table-body-wrapper::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        #data-table-body-wrapper::-webkit-scrollbar-track { background: #1e293b; }
        
        @keyframes pulse-once {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pulse-on-update { animation: pulse-once 0.5s ease-in-out; }
        .ai-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-10">
    <div class="container mx-auto max-w-[1500px]">
        <header class="text-center mb-12">
            <h1 class="text-4xl sm:text-6xl font-extrabold mb-3 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-teal-400">
                Indian Capitals Air Quality
            </h1>
            <p class="text-xl text-gray-400">Real-time Environmental Monitoring with <span class="text-indigo-400">Gemini AI</span></p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Sidebar Controls -->
            <div class="lg:col-span-1 space-y-8">
                
                <div class="card">
                    <h2 class="text-2xl font-semibold mb-5 text-teal-400 flex items-center">
                        <i data-lucide="map-pin" class="w-6 h-6 mr-3"></i>
                        Select Location
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label for="city-select" class="block text-sm font-medium text-gray-300 mb-1">Monitored Cities:</label>
                            <select id="city-select" class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-teal-500 focus:border-teal-500 transition duration-150 shadow-inner" onchange="handleCityChange()">
                            </select>
                        </div>
                        
                        <div class="pt-2 border-t border-gray-700">
                             <label for="health-profile" class="block text-sm font-medium text-gray-300 mb-1 mt-3">Your Health Profile:</label>
                             <select id="health-profile" class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-teal-500 focus:border-teal-500 transition duration-150 shadow-inner mb-3">
                                <option value="General Public">General Public</option>
                                <option value="Asthma/Respiratory Issues">Asthma / Respiratory Issues</option>
                                <option value="Elderly">Elderly (65+)</option>
                                <option value="Active Runner/Athlete">Active Runner / Athlete</option>
                                <option value="Children">Children</option>
                                <option value="Heart Condition">Heart Condition</option>
                                <option value="Pregnant">Pregnant Woman</option>
                            </select>
                            
                            <button id="btn-health" onclick="getHealthAdvice()" class="w-full flex items-center justify-center bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg shadow-rose-900/50 mb-3">
                                <i data-lucide="heart-pulse" class="w-4 h-4 mr-2"></i>
                                Check Health Safety
                            </button>
                        </div>

                        <div class="flex flex-col gap-3 pt-2 border-t border-gray-700">
                            <button id="btn-trip" onclick="planTrip()" class="w-full flex items-center justify-center bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg shadow-emerald-900/50">
                                <i data-lucide="map" class="w-4 h-4 mr-2"></i>
                                Plan Low-AQI Trip
                            </button>
                            <button id="btn-speak" onclick="speakStatus()" class="w-full flex items-center justify-center bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg shadow-pink-900/50">
                                <i data-lucide="volume-2" class="w-4 h-4 mr-2"></i>
                                Audio Report
                            </button>
                        </div>
                    </div>
                </div>

                <div id="health-output-card" class="card hidden transition-all duration-500 bg-rose-900/20 border-rose-500/30">
                    <h2 class="text-xl font-semibold mb-3 text-rose-400 flex items-center">
                        <i data-lucide="activity" class="w-5 h-5 mr-2"></i>
                        Personalized Health Alert
                    </h2>
                    <div id="health-output-content" class="text-sm text-gray-300 leading-relaxed space-y-2"></div>
                </div>

                <div id="trip-output-card" class="card hidden transition-all duration-500 bg-emerald-900/20 border-emerald-500/30">
                    <h2 class="text-xl font-semibold mb-3 text-emerald-400 flex items-center">
                        <i data-lucide="compass" class="w-5 h-5 mr-2"></i>
                        Trip Suggestions
                    </h2>
                    <div id="trip-output-content" class="text-sm text-gray-300 leading-relaxed space-y-2"></div>
                </div>

                <!-- Reading Details -->
                <div class="card">
                    <h2 class="text-2xl font-semibold mb-5 text-teal-400 flex items-center">
                        <i data-lucide="gauge" class="w-6 h-6 mr-3"></i>
                        Latest Reading
                    </h2>
                    <div id="latest-reading-content" class="space-y-4">
                        <p class="text-lg"><span class="font-medium text-gray-400">Timestamp:</span> <span id="latest-timestamp" class="text-white font-mono text-sm">N/A</span></p>
                        <div id="latest-aqi-card" class="flex items-center justify-between p-4 bg-gray-700 rounded-xl transition duration-500 text-white shadow-xl">
                            <span class="font-bold text-xl text-white flex items-center">
                                <i data-lucide="cloud" class="w-6 h-6 mr-2"></i>
                                AQI (PM2.5):
                            </span>
                            <span id="latest-aqi" class="text-4xl font-extrabold">N/A</span>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div id="latest-temp-card" class="p-4 bg-gray-700 rounded-xl transition duration-500 text-white">
                                <span class="block text-gray-300 flex items-center mb-1"><i data-lucide="thermometer" class="w-4 h-4 mr-2 text-red-400"></i>Temp:</span>
                                <span id="latest-temp" class="font-semibold text-lg">N/A</span>
                            </div>
                            <div id="latest-humidity-card" class="p-4 bg-gray-700 rounded-xl transition duration-500 text-white">
                                <span class="block text-gray-300 flex items-center mb-1"><i data-lucide="droplets" class="w-4 h-4 mr-2 text-blue-400"></i>Humidity:</span>
                                <span id="latest-humidity" class="font-semibold text-lg">N/A</span>
                            </div>
                            <div id="latest-wind-card" class="p-4 bg-gray-700 rounded-xl transition duration-500 text-white">
                                <span class="block text-gray-300 flex items-center mb-1"><i data-lucide="wind" class="w-4 h-4 mr-2 text-green-400"></i>Wind Speed:</span>
                                <span id="latest-wind" class="font-semibold text-lg">N/A</span>
                            </div>
                            <div id="latest-status-card" class="p-4 bg-gray-700 rounded-xl transition duration-500 text-white flex flex-col justify-center">
                                <span class="block text-gray-300 flex items-center mb-1"><i data-lucide="activity" class="w-4 h-4 mr-2 text-purple-400"></i>Status:</span>
                                <span id="latest-status" class="quality-status-badge bg-gray-500 text-white mt-1 w-fit">N/A</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visualization and History -->
            <div class="lg:col-span-2 space-y-8">
                <div class="card">
                    <h2 class="text-2xl font-semibold mb-5 text-teal-400 flex items-center">
                        <i data-lucide="line-chart" class="w-6 h-6 mr-3"></i>
                        AQI Trend
                    </h2>
                    <div class="chart-container">
                        <canvas id="aqiChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-2xl font-semibold mb-5 text-teal-400 flex items-center">
                        <i data-lucide="table" class="w-6 h-6 mr-3"></i>
                        Full Data History
                    </h2>
                    <div class="overflow-x-auto">
                        <div id="data-table-body-wrapper">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead class="bg-gray-800 sticky top-0 z-10">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider rounded-tl-lg">Timestamp</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">AQI (PM2.5)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Temp</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Humidity</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider rounded-tr-lg">Wind</th>
                                    </tr>
                                </thead>
                                <tbody id="data-table-body" class="bg-gray-900 divide-y divide-gray-800">
                                    <tr><td colspan="6" class="p-4 text-center text-gray-500">Connecting to live feed...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <audio id="audio-player" class="hidden"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // INTERNAL API KEYS (PASTE YOUR KEYS HERE)
        // ==========================================
        const INTERNAL_GEMINI_KEY = "AIzaSyC-V8hfecz6bI5DF8Z45C8-8eNQDoqVnoQ";   // <-- Paste Gemini Key Here
        const INTERNAL_WEATHER_KEY = "3d23095ff5eae1ad55974249310c60b3";  // <-- Paste WeatherAPI Key Here
        // ==========================================

        let activeGeminiKey = INTERNAL_GEMINI_KEY; 
        let activeWeatherKey = INTERNAL_WEATHER_KEY; 
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'indian-aqi-monitor';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let cityData = {}; 
        let chartInstance = null;
        let unsubscribe = null; 
        let realtimeInterval = null; 

        const DATA_COLLECTION_PATH = `artifacts/${appId}/public/data/air-quality`;

        const capitals = [
            "New Delhi", "Mumbai", "Kolkata", "Chennai", "Bengaluru", "Hyderabad", 
            "Lucknow", "Patna", "Jaipur", "Bhopal", "Gandhinagar", "Bhubaneswar", 
            "Ranchi", "Dispur", "Shimla", "Thiruvananthapuram", "Panaji", "Chandigarh",
            "Raipur", "Amaravati", "Port Blair", "Itanagar", "Imphal", "Shillong",
            "Aizawl", "Kohima", "Gangtok", "Agartala", "Dehradun", "Srinagar",
            "Daman", "Puducherry", "Leh", "Kavaratti"
        ];

        // --- WEATHER API LOGIC ---
        async function fetchWeatherData(city) {
            if (!activeWeatherKey) {
                console.warn("WeatherAPI Key missing. Using fallback mock data.");
                return generateMockReading(city);
            }

            const url = `https://api.weatherapi.com/v1/current.json?key=${activeWeatherKey}&q=${city}&aqi=yes`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`WeatherAPI error: ${response.status}`);
                const data = await response.json();

                return {
                    city: city,
                    timestamp: new Date(),
                    aqi: data.current.air_quality.pm2_5 || 0,
                    temperature: data.current.temp_c,
                    humidity: data.current.humidity,
                    wind_speed: data.current.wind_kph * 0.27778, 
                    userId: userId || 'anonymous'
                };
            } catch (err) {
                console.error("Fetch failed:", err);
                return generateMockReading(city);
            }
        }

        function generateMockReading(city) {
            return {
                city,
                timestamp: new Date(),
                aqi: 50 + Math.random() * 200,
                temperature: 20 + Math.random() * 15,
                humidity: 40 + Math.random() * 40,
                wind_speed: 1 + Math.random() * 5,
                userId: userId || 'anonymous'
            };
        }

        // --- AI UTILITIES ---
        async function fetchWithBackoff(url, options, maxRetries = 3) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`Status: ${response.status}`);
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        async function getHealthAdvice() {
            if (!activeGeminiKey) {
                alert("Internal API Key Required: Please add your Gemini key to the code.");
                return;
            }

            const selectedCity = document.getElementById('city-select').value;
            const profile = document.getElementById('health-profile').value;
            const card = document.getElementById('health-output-card');
            const content = document.getElementById('health-output-content');
            const btn = document.getElementById('btn-health');
            
            card.classList.remove('hidden');
            if (!cityData[selectedCity]?.length) return;

            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 mr-2 ai-spinner"></i> Analysing...`;
            content.innerHTML = 'Analyzing health risks based on profile...';
            lucide.createIcons();

            const latest = cityData[selectedCity][cityData[selectedCity].length - 1];
            const prompt = `Location: ${selectedCity}. Current PM2.5 AQI: ${latest.aqi.toFixed(0)}. Temp: ${latest.temperature.toFixed(1)}C. User Profile: ${profile}. Provide a 2-sentence medical recommendation for activity today.`;

            try {
                const response = await fetchWithBackoff(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${activeGeminiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    }
                );
                const result = await response.json();
                content.innerHTML = result.candidates[0].content.parts[0].text;
            } catch (error) {
                content.innerHTML = "API Error: Check your Gemini Key in the code.";
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="heart-pulse" class="w-4 h-4 mr-2"></i> Check Health Safety`;
                lucide.createIcons();
            }
        }

        async function planTrip() {
            if (!activeGeminiKey) {
                alert("Internal API Key Required: Please add your Gemini key to the code.");
                return;
            }

            const selectedCity = document.getElementById('city-select').value;
            const card = document.getElementById('trip-output-card');
            const content = document.getElementById('trip-output-content');
            const btn = document.getElementById('btn-trip');
            
            card.classList.remove('hidden');
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 mr-2 ai-spinner"></i> Searching...`;
            content.innerHTML = 'Finding cleaner getaway options...';
            lucide.createIcons();

            const prompt = `Recommend 3 weekend getaways within 300km of ${selectedCity} that typically have better air quality. Brief bullet points.`;

            try {
                const response = await fetchWithBackoff(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${activeGeminiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], tools: [{ "google_search": {} }] })
                    }
                );
                const result = await response.json();
                content.innerHTML = result.candidates[0].content.parts[0].text;
            } catch (error) {
                content.innerHTML = "Search Error: Could not retrieve suggestions.";
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="map" class="w-4 h-4 mr-2"></i> Plan Low-AQI Trip`;
                lucide.createIcons();
            }
        }

        async function speakStatus() {
            if (!activeGeminiKey) {
                alert("Internal API Key Required: Please add your Gemini key to the code.");
                return;
            }

            const city = document.getElementById('city-select').value;
            const btn = document.getElementById('btn-speak');
            if (!cityData[city]?.length) return;
            
            const latest = cityData[city][cityData[city].length - 1];
            const script = `Weather report for ${city}. The PM 2 point 5 Air Quality Index is ${latest.aqi.toFixed(0)}. Temperature is ${latest.temperature.toFixed(1)} degrees Celsius.`;

            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 mr-2 ai-spinner"></i> Generating...`;
            lucide.createIcons();

            try {
                const response = await fetchWithBackoff(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${activeGeminiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: script }] }],
                            generationConfig: {
                                responseModalities: ["AUDIO"],
                                speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Aoede" } } }
                            }
                        })
                    }
                );
                const result = await response.json();
                const audioData = result.candidates[0].content.parts[0].inlineData.data;
                const binary = atob(audioData);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                
                const blob = new Blob([bytes.buffer], { type: 'audio/wav' });
                const url = URL.createObjectURL(blob);
                const player = document.getElementById('audio-player');
                player.src = url;
                player.play();
            } catch (e) {
                console.error(e);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="volume-2" class="w-4 h-4 mr-2"></i> Audio Report`;
                lucide.createIcons();
            }
        }

        // --- FIREBASE & CORE LOGIC ---
        async function initialize() {
            populateCities();
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                else await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        startListeners();
                        if (activeWeatherKey) handleCityChange();
                    }
                });
            } catch (e) { console.error(e); }
        }

        function populateCities() {
            const select = document.getElementById('city-select');
            capitals.sort().forEach(city => {
                const opt = document.createElement('option');
                opt.value = opt.textContent = city;
                select.appendChild(opt);
            });
            select.value = "New Delhi";
        }

        function startListeners() {
            const q = query(collection(db, DATA_COLLECTION_PATH));
            unsubscribe = onSnapshot(q, (snapshot) => {
                const newData = {};
                snapshot.forEach(doc => {
                    const d = doc.data();
                    if (!newData[d.city]) newData[d.city] = [];
                    const ts = d.timestamp?.toDate ? d.timestamp.toDate() : new Date(d.timestamp);
                    newData[d.city].push({...d, timestamp: ts});
                });
                
                for (let c in newData) newData[c].sort((a,b) => a.timestamp - b.timestamp);
                cityData = newData;
                updateDashboard(true);
            });

            if (realtimeInterval) clearInterval(realtimeInterval);
            realtimeInterval = setInterval(async () => {
                const city = document.getElementById('city-select').value;
                const reading = await fetchWeatherData(city);
                if (reading && db) {
                    try { await addDoc(collection(db, DATA_COLLECTION_PATH), reading); } catch(e){}
                }
            }, 30000);
        }

        function handleCityChange() {
            document.getElementById('trip-output-card').classList.add('hidden');
            document.getElementById('health-output-card').classList.add('hidden');
            
            const city = document.getElementById('city-select').value;
            fetchWeatherData(city).then(reading => {
                if (reading && db) addDoc(collection(db, DATA_COLLECTION_PATH), reading);
            });
            
            updateDashboard();
        }

        function getAqiStatus(aqi) {
            if (aqi <= 50) return { label: 'Good', tailwindClass: 'bg-green-600 text-white', aqiCardClass: 'bg-green-800/80', detailCardClass: 'bg-green-900' };
            if (aqi <= 100) return { label: 'Moderate', tailwindClass: 'bg-yellow-500 text-black', aqiCardClass: 'bg-amber-700/80', detailCardClass: 'bg-amber-800' };
            if (aqi <= 150) return { label: 'Sensitive', tailwindClass: 'bg-orange-500 text-white', aqiCardClass: 'bg-orange-700/80', detailCardClass: 'bg-orange-800' };
            if (aqi <= 200) return { label: 'Unhealthy', tailwindClass: 'bg-red-600 text-white', aqiCardClass: 'bg-red-800/80', detailCardClass: 'bg-red-900' };
            return { label: 'Very Unhealthy', tailwindClass: 'bg-purple-700 text-white', aqiCardClass: 'bg-purple-900/80', detailCardClass: 'bg-purple-950' };
        }

        function updateDashboard(pulse = false) {
            const city = document.getElementById('city-select').value;
            const data = cityData[city] || [];
            
            if (!data.length) {
                document.getElementById('latest-aqi').textContent = "---";
                return;
            }

            const latest = data[data.length - 1];
            const status = getAqiStatus(latest.aqi);

            document.getElementById('latest-timestamp').textContent = latest.timestamp.toLocaleTimeString();
            document.getElementById('latest-aqi').textContent = latest.aqi.toFixed(0);
            document.getElementById('latest-temp').textContent = `${latest.temperature.toFixed(1)}°C`;
            document.getElementById('latest-humidity').textContent = `${latest.humidity.toFixed(0)}%`;
            document.getElementById('latest-wind').textContent = `${latest.wind_speed.toFixed(1)} m/s`;
            
            const statusEl = document.getElementById('latest-status');
            statusEl.textContent = status.label;
            statusEl.className = `quality-status-badge ${status.tailwindClass} mt-1 w-fit`;

            document.getElementById('latest-aqi-card').className = `flex items-center justify-between p-4 rounded-xl transition duration-500 ${status.aqiCardClass} text-white shadow-xl ${pulse ? 'pulse-on-update' : ''}`;

            updateTable(data);
            updateChart(data);
            lucide.createIcons();
        }

        function updateTable(data) {
            const body = document.getElementById('data-table-body');
            body.innerHTML = '';
            data.slice().reverse().forEach(item => {
                const row = body.insertRow();
                row.className = 'hover:bg-gray-800/50 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-3 text-sm text-gray-300">${item.timestamp.toLocaleTimeString()}</td>
                    <td class="px-6 py-3 text-sm font-bold text-white">${item.aqi.toFixed(1)}</td>
                    <td class="px-6 py-3 text-xs"><span class="quality-status-badge ${getAqiStatus(item.aqi).tailwindClass}">${getAqiStatus(item.aqi).label}</span></td>
                    <td class="px-6 py-3 text-sm text-gray-400">${item.temperature.toFixed(1)}°C</td>
                    <td class="px-6 py-3 text-sm text-gray-400">${item.humidity.toFixed(0)}%</td>
                    <td class="px-6 py-3 text-sm text-gray-400">${item.wind_speed.toFixed(1)}</td>
                `;
            });
        }

        function updateChart(data) {
            const ctx = document.getElementById('aqiChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.timestamp),
                    datasets: [{
                        data: data.map(d => d.aqi),
                        borderColor: '#38bdf8',
                        backgroundColor: 'rgba(56, 189, 248, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'minute' }, ticks: { color: '#64748b' } },
                        y: { min: 0, ticks: { color: '#64748b' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        window.handleCityChange = handleCityChange;
        window.getHealthAdvice = getHealthAdvice;
        window.planTrip = planTrip;
        window.speakStatus = speakStatus;
        window.onload = initialize;
    </script>
</body>
</html>
